"""
Exploit management and execution models.
"""

from datetime import datetime
from enum import Enum
from typing import List, Optional
import uuid

from sqlalchemy import Boolean, Enum as SQLEnum, ForeignKey, String, Text
from sqlalchemy.orm import Mapped, mapped_column, relationship
from sqlalchemy.dialects.postgresql import JSONB, ARRAY, UUID

from .base import Base


class ExploitType(str, Enum):
    """Exploit type enumeration."""
    REMOTE = "remote"
    LOCAL = "local"
    WEB = "web"
    CLIENT_SIDE = "client_side"
    PRIVILEGE_ESCALATION = "privilege_escalation"


class ExploitStatus(str, Enum):
    """Exploit status enumeration."""
    DRAFT = "draft"
    VERIFIED = "verified"
    UNTESTED = "untested"
    BROKEN = "broken"
    DEPRECATED = "deprecated"


class ExecutionStatus(str, Enum):
    """Exploit execution status enumeration."""
    PENDING = "pending"
    RUNNING = "running"
    SUCCESS = "success"
    FAILED = "failed"
    TIMEOUT = "timeout"


class Exploit(Base):
    """Exploit model for managing exploits."""
    
    __tablename__ = "exploits"
    
    # Exploit details
    name: Mapped[str] = mapped_column(String(200), nullable=False, index=True)
    description: Mapped[Optional[str]] = mapped_column(Text)
    exploit_type: Mapped[ExploitType] = mapped_column(
        SQLEnum(ExploitType), 
        nullable=False
    )
    status: Mapped[ExploitStatus] = mapped_column(
        SQLEnum(ExploitStatus), 
        default=ExploitStatus.DRAFT, 
        nullable=False
    )
    
    # Target information
    target_platform: Mapped[Optional[str]] = mapped_column(String(50))
    target_service: Mapped[Optional[str]] = mapped_column(String(100))
    target_version: Mapped[Optional[str]] = mapped_column(String(100))
    cve_id: Mapped[Optional[str]] = mapped_column(String(50), index=True)
    
    # Exploit content
    code: Mapped[str] = mapped_column(Text, nullable=False)
    language: Mapped[str] = mapped_column(String(50), nullable=False)  # python, ruby, go, etc.
    dependencies: Mapped[Optional[List[str]]] = mapped_column(ARRAY(String))
    
    # Metadata
    author: Mapped[str] = mapped_column(String(100), nullable=False)
    source: Mapped[Optional[str]] = mapped_column(String(200))
    tags: Mapped[Optional[List[str]]] = mapped_column(ARRAY(String))
    
    # Verification
    verified_by: Mapped[Optional[str]] = mapped_column(UUID(as_uuid=True), ForeignKey("users.id"))
    verified_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True))
    
    # Configuration schema
    config_schema: Mapped[Optional[dict]] = mapped_column(JSONB)
    
    # Relationships
    executions: Mapped[List["ExploitExecution"]] = relationship(
        "ExploitExecution", 
        back_populates="exploit", 
        cascade="all, delete-orphan"
    )
    
    def __repr__(self) -> str:
        return f"<Exploit(id={self.id}, name={self.name}, type={self.exploit_type})>"


class ExploitExecution(Base):
    """Exploit execution tracking model."""
    
    __tablename__ = "exploit_executions"
    
    # Foreign keys
    exploit_id: Mapped[str] = mapped_column(
        UUID(as_uuid=True), 
        ForeignKey("exploits.id"), 
        nullable=False
    )
    user_id: Mapped[str] = mapped_column(
        UUID(as_uuid=True), 
        ForeignKey("users.id"), 
        nullable=False
    )
    project_id: Mapped[Optional[str]] = mapped_column(
        UUID(as_uuid=True), 
        ForeignKey("projects.id")
    )
    
    # Target
    target_host: Mapped[str] = mapped_column(String(255), nullable=False)
    target_port: Mapped[Optional[int]] = mapped_column(Integer)
    
    # Configuration
    config: Mapped[Optional[dict]] = mapped_column(JSONB)
    arguments: Mapped[Optional[List[str]]] = mapped_column(ARRAY(String))
    
    # Execution status
    status: Mapped[ExecutionStatus] = mapped_column(
        SQLEnum(ExecutionStatus), 
        default=ExecutionStatus.PENDING, 
        nullable=False
    )
    
    # Timing
    started_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True))
    completed_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True))
    
    # Results
    success: Mapped[bool] = mapped_column(Boolean, default=False)
    session_id: Mapped[Optional[str]] = mapped_column(String(100))
    output: Mapped[Optional[str]] = mapped_column(Text)
    error: Mapped[Optional[str]] = mapped_column(Text)
    
    # Payload/result data
    payload_sent: Mapped[Optional[str]] = mapped_column(Text)
    result_data: Mapped[Optional[dict]] = mapped_column(JSONB)
    
    # Relationships
    exploit: Mapped["Exploit"] = relationship("Exploit", back_populates="executions")
    user: Mapped["User"] = relationship("User", back_populates="exploits")
    
    def __repr__(self) -> str:
        return f"<ExploitExecution(id={self.id}, exploit_id={self.exploit_id}, status={self.status})>"